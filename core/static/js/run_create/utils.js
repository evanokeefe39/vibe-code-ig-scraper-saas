// Utility functions for run creation form
const RunCreateUtils = {
    // Parse textarea input into array of non-empty lines
    parseTextareaInput: function(textarea) {
        if (!textarea || !textarea.value) return [];
        return textarea.value.split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);
    },

    // Parse URLs from textarea and return as array of objects
    parseUrlsFromTextarea: function(textarea) {
        const urls = this.parseTextareaInput(textarea);
        return urls.map(url => ({ url }));
    },

    // Parse hashtags from textarea (remove # symbols)
    parseHashtagsFromTextarea: function(textarea) {
        const hashtags = this.parseTextareaInput(textarea);
        return hashtags.map(tag => tag.replace('#', ''));
    },

    // Get integer value from input, return null if empty or invalid
    parseIntFromInput: function(input) {
        if (!input || !input.value) return null;
        const value = parseInt(input.value);
        return isNaN(value) ? null : value;
    },

    // Get boolean value from checkbox
    getCheckboxValue: function(checkbox) {
        return checkbox ? checkbox.checked : false;
    },

    // Get select value, return null if empty
    getSelectValue: function(select) {
        if (!select || !select.value) return null;
        return select.value;
    },

    // Get input value, return null if empty
    getInputValue: function(input) {
        if (!input || !input.value) return null;
        return input.value.trim();
    },

    // Show loading state on button
    showLoadingState: function(button, loadingText = 'Processing...') {
        if (!button) return;
        
        const originalText = button.innerHTML;
        button.innerHTML = `
            <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            ${loadingText}
        `;
        button.disabled = true;
        
        return originalText;
    },

    // Restore button state
    restoreButtonState: function(button, originalText) {
        if (!button) return;
        button.innerHTML = originalText;
        button.disabled = false;
    },

    // Validate that source has required data
    validateSourceData: function(sourceType, config) {
        let hasData = false;
        
        if (sourceType.startsWith('youtube-')) {
            if (sourceType === 'youtube-search') {
                hasData = config.searchQueries && config.searchQueries.length > 0;
            } else {
                hasData = config.startUrls && config.startUrls.length > 0;
            }
        } else if (sourceType.startsWith('instagram-')) {
            if (sourceType === 'instagram-search') {
                hasData = config.searchQueries && config.searchQueries.length > 0;
            } else {
                hasData = config.directUrls && config.directUrls.length > 0;
            }
        } else if (sourceType.startsWith('tiktok-')) {
            if (sourceType === 'tiktok-profile') {
                hasData = config.profiles && config.profiles.length > 0;
            } else if (sourceType === 'tiktok-hashtag') {
                hasData = config.hashtags && config.hashtags.length > 0;
            } else if (sourceType === 'tiktok-search') {
                hasData = config.searchQueries && config.searchQueries.length > 0;
            } else if (sourceType === 'tiktok-video') {
                hasData = config.postURLs && config.postURLs.length > 0;
            }
        }
        
        return hasData;
    },

    // Extract universal options from source card
    extractUniversalOptions: function(sourceCard, config = {}) {
        const maxResultsInput = sourceCard.querySelector('.max-results-input');
        const maxResultsShortsInput = sourceCard.querySelector('.max-results-shorts-input');
        const maxResultsStreamsInput = sourceCard.querySelector('.max-results-streams-input');
        const oldestPostDateInput = sourceCard.querySelector('.oldest-post-date-input');
        const newestPostDateInput = sourceCard.querySelector('.newest-post-date-input');
        const downloadSubtitlesCheckbox = sourceCard.querySelector('.download-subtitles-checkbox');
        const subtitlesLanguageSelect = sourceCard.querySelector('.subtitles-language-select');
        const subtitlesFormatSelect = sourceCard.querySelector('.subtitles-format-select');
        const preferAutoGeneratedSubtitlesCheckbox = sourceCard.querySelector('.prefer-auto-generated-subtitles-checkbox');
        
        if (maxResultsInput) {
            const value = this.parseIntFromInput(maxResultsInput);
            if (value !== null) config.maxResults = value;
        }
        
        if (maxResultsShortsInput) {
            const value = this.parseIntFromInput(maxResultsShortsInput);
            if (value !== null) config.maxResultsShorts = value;
        }
        
        if (maxResultsStreamsInput) {
            const value = this.parseIntFromInput(maxResultsStreamsInput);
            if (value !== null) config.maxResultsStreams = value;
        }
        
        if (oldestPostDateInput) {
            const value = this.getInputValue(oldestPostDateInput);
            if (value !== null) config.oldestPostDate = value;
        }
        
        if (newestPostDateInput) {
            const value = this.getInputValue(newestPostDateInput);
            if (value !== null) config.newestPostDate = value;
        }
        
        if (downloadSubtitlesCheckbox) {
            config.downloadSubtitles = this.getCheckboxValue(downloadSubtitlesCheckbox);
        }
        
        if (subtitlesLanguageSelect) {
            const value = this.getSelectValue(subtitlesLanguageSelect);
            if (value !== null) config.subtitlesLanguage = value;
        }
        
        if (subtitlesFormatSelect) {
            const value = this.getSelectValue(subtitlesFormatSelect);
            if (value !== null) config.subtitlesFormat = value;
        }
        
        if (preferAutoGeneratedSubtitlesCheckbox) {
            config.preferAutoGeneratedSubtitles = this.getCheckboxValue(preferAutoGeneratedSubtitlesCheckbox);
        }
        
        return config;
    }
};

// Export for use in other modules
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { RunCreateUtils };
} else {
    window.RunCreateUtils = RunCreateUtils;
}
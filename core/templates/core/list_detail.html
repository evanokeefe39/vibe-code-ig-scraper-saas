{% extends "base.html" %}

{% block title %}{{ list.name }} - Vibe Scraper SaaS{% endblock %}

{% block footer %}{% endblock %}

{% block content %}
<!-- CSRF protection enabled -->

<div class="w-full max-w-screen-2xl mx-auto px-4 py-8">
    <div class="mb-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ list.name }}</h1>
                {% if list.description %}
                <p class="text-gray-600">{{ list.description }}</p>
                {% endif %}
                <p class="text-sm text-gray-500 mt-2">{{ rows|length }} items</p>
            </div>
            <div class="flex space-x-4">
                <a href="{% url 'list_list' %}"
                   class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors duration-200">
                    ‚Üê Back to Lists
                </a>
                <button onclick="showDeleteListModal()"
                        class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete List
                </button>
            </div>
        </div>
    </div>

    {% include "snippets/_table_editor.html" %}
      </div>

<!-- Inline Edit Modal -->
<div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="edit-modal-title">Edit Cell</h3>
            <div id="edit-modal-content">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                <button onclick="saveCellEdit()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete List Modal -->
<div id="delete-list-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-red-600 mb-4">Delete List</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">This action cannot be undone. All data in this list will be permanently deleted.</p>
                <p class="text-sm text-gray-600 mb-4">Type <strong>"{{ list.name }}"</strong> to confirm:</p>
                <input type="text" id="delete-confirmation-input"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                       placeholder="Type the list name here">
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="hideDeleteListModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                <button onclick="confirmDeleteList()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete List</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Column Modal -->
<div id="add-column-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Add New Column</h3>
            <div class="mb-4">
                <label for="column-name" class="block text-sm font-medium text-gray-700 mb-2">Column Name</label>
                <input type="text" id="column-name"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 mb-4"
                       placeholder="Enter column name">
                <label for="column-type" class="block text-sm font-medium text-gray-700 mb-2">Column Type</label>
                <select id="column-type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="boolean">Checkbox</option>
                    <option value="date">Date</option>
                    <option value="url">URL</option>
                    <option value="select">Select</option>
                    <option value="multi_select">Multi-Select</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="hideAddColumnModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                <button onclick="confirmAddColumn()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Column</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}

{% endblock %}

{% block extra_js %}
<script>
// CSRF token setup for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Global variables
let currentEditCell = null;
let currentEditRowId = null;
let currentEditColumn = null;
let currentEditType = null;



// Cell editing functions
function editCell(rowId, columnName, columnType, cellElement) {
    // Set global variables
    currentEditRowId = rowId;
    currentEditColumn = columnName;
    currentEditType = columnType;

    // Get current value
    let currentValue = '';
    if (columnType === 'boolean') {
        const checkbox = cellElement.querySelector('input[type="checkbox"]');
        currentValue = checkbox ? checkbox.checked : false;
    } else {
        currentValue = cellElement.textContent.trim();
    }

    // Create input HTML based on type
    let inputHtml = '';
    if (columnType === 'boolean') {
        inputHtml = `<input type="checkbox" id="edit-input" ${currentValue ? 'checked' : ''} class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">`;
    } else {
        inputHtml = `<input type="text" id="edit-input" value="${currentValue}" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">`;
    }

    // Show modal
    const modal = document.getElementById('edit-modal');
    const content = document.getElementById('edit-modal-content');
    const title = document.getElementById('edit-modal-title');

    title.textContent = `Edit ${columnName}`;
    content.innerHTML = inputHtml;
    modal.classList.remove('hidden');

    // Focus the input
    setTimeout(() => {
        const input = document.getElementById('edit-input');
        if (input) {
            input.focus();
            if (input.type !== 'checkbox') {
                input.select();
            }
        }
    }, 100);
}

// Save cell edit
function saveCellEdit() {
    const input = document.getElementById('edit-input');
    if (!input) return;

    let value;
    if (currentEditType === 'boolean') {
        value = input.checked;
    } else {
        value = input.value;
    }

    // Send AJAX request to update the cell
    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/rows/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `row_id=${currentEditRowId}&column=${encodeURIComponent(currentEditColumn)}&value=${encodeURIComponent(value)}&type=${currentEditType}`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error updating cell');
        }
    });

    closeEditModal();
}

// Close edit modal
function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    currentEditCell = null;
    currentEditRowId = null;
    currentEditColumn = null;
    currentEditType = null;
}

// Add new row
function addNewRow() {
    const listId = {{ list.pk }};
    // Redirect to the row creation page
    window.location.href = `/lists/${listId}/rows/create/`;
}

// Delete row
function deleteRow(rowId) {
    if (!confirm('Are you sure you want to delete this row?')) return;

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/rows/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `row_id=${rowId}`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error deleting row');
        }
    });
}

// CSRF protection enabled

// Column resizing functionality
function setupColumnResizing() {
    const table = document.getElementById('notion-table');
    const ths = table.querySelectorAll('th.resizable');

    ths.forEach(th => {
        th.addEventListener('mousedown', function(e) {
            if (e.offsetX > th.offsetWidth - 10) { // Only resize if clicking on the right edge
                isResizing = true;
                currentResizingTh = th;
                startX = e.pageX;
                startWidth = th.offsetWidth;
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
            }
        });
    });

    document.addEventListener('mousemove', function(e) {
        if (isResizing && currentResizingTh) {
            const newWidth = startWidth + (e.pageX - startX);
            if (newWidth >= 80 && newWidth <= 400) { // Min 80px, max 400px
                currentResizingTh.style.width = newWidth + 'px';
                // Save to localStorage for persistence
                const columnId = currentResizingTh.dataset.columnId;
                localStorage.setItem(`column-width-${columnId}`, newWidth);
            }
        }
    });

    document.addEventListener('mouseup', function() {
        if (isResizing) {
            isResizing = false;
            currentResizingTh = null;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });

    // Load saved widths on page load
    ths.forEach(th => {
        const columnId = th.dataset.columnId;
        const savedWidth = localStorage.getItem(`column-width-${columnId}`);
        if (savedWidth) {
            th.style.width = savedWidth + 'px';
        }
    });
}



// Add column modal functions
function showAddColumnModal() {
    document.getElementById('add-column-modal').classList.remove('hidden');
    document.getElementById('column-name').focus();
}

function hideAddColumnModal() {
    document.getElementById('add-column-modal').classList.add('hidden');
    document.getElementById('column-name').value = '';
    document.getElementById('column-type').selectedIndex = 0;
}

function confirmAddColumn() {
    const name = document.getElementById('column-name').value.trim();
    const type = document.getElementById('column-type').value;

    if (!name) {
        alert('Please enter a column name.');
        document.getElementById('column-name').focus();
        return;
    }

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/columns/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `name=${encodeURIComponent(name)}&column_type=${type}&required=false`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error adding column');
        }
    })
    .catch(error => {
        alert('Error adding column');
    });

    hideAddColumnModal();
}

// Delete list modal functions
function showDeleteListModal() {
    document.getElementById('delete-list-modal').classList.remove('hidden');
    document.getElementById('delete-confirmation-input').focus();
}

function hideDeleteListModal() {
    document.getElementById('delete-list-modal').classList.add('hidden');
    document.getElementById('delete-confirmation-input').value = '';
}

function confirmDeleteList() {
    const input = document.getElementById('delete-confirmation-input');
    const confirmation = input.value.trim();
    const listName = '{{ list.name }}';

    if (confirmation !== listName) {
        alert('Please type the exact list name to confirm deletion.');
        input.focus();
        return;
    }

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `confirmation=${encodeURIComponent(confirmation)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{% url "list_list" %}';
        } else {
            alert(data.error || 'Error deleting list');
        }
    })
    .catch(error => {
        alert('Error deleting list');
    });
}
</script>
{% endblock %}
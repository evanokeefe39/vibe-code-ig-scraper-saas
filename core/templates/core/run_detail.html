{% extends "base.html" %}

{% block title %}Run #{{ run.pk }} - Vibe Scraper SaaS{% endblock %}

{% block content %}
    <div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-8">
        <nav class="flex mb-4" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                     <a href="{% url 'run_list' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-primary-600">
                        <svg class="w-3 h-3 mr-2.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2A1 1 0 0 0 1 10h2v8a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-8h2a1 1 0 0 0 .707-1.707Z"/>
                        </svg>
                        Runs
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-3 h-3 text-gray-400 mx-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5 7 7-7 7"/>
                        </svg>
                        <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Run #{{ run.pk }}</span>
                    </div>
                </li>
            </ol>
         </nav>



          <div class="flex items-center justify-between">
             <div>
                  <h1 class="text-3xl font-bold text-gray-900">Run #{{ run.pk }}</h1>
                  <p class="text-gray-600 mt-1">Created {{ run.created_at|date:"M j, Y g:i A" }}</p>
             </div>
              <div class="flex items-center space-x-6">
                  <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                      {% if execution_status == 'success' %}
                          bg-green-100 text-green-800
                      {% elif execution_status == 'running' or execution_status == 'waiting' %}
                          bg-blue-100 text-blue-800 animate-pulse
                      {% elif execution_status == 'failed' or execution_status == 'error' %}
                          bg-red-100 text-red-800
                      {% else %}
                          bg-yellow-100 text-yellow-800
                      {% endif %}">
                  {% if execution_status == 'running' %}
                      <svg class="inline-block animate-spin mr-2 h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
                          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                  {% endif %}
                      {% if execution_status == 'success' %}
                          Completed
                      {% elif execution_status == 'running' %}
                          Running
                      {% elif execution_status == 'waiting' %}
                          Waiting
                      {% elif execution_status == 'failed' or execution_status == 'error' %}
                          Failed
                      {% else %}
                          {{ execution_status|title }}
                      {% endif %}
                  </span>

              </div>
          </div>
    </div>

    <div class="grid md:grid-cols-2 gap-8">
        <!-- Input Configuration -->
        <!-- Scraping Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Scraping Configuration</h2>
             {% if run.input %}
                 <script id="input-data" type="application/json">{{ input_json|safe }}</script>
                 <div class="space-y-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Instagram Profiles</h3>
                        <div class="bg-gray-50 rounded-lg p-3">
                            <ul id="profiles-list" class="text-sm text-gray-800"></ul>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Scraping Parameters</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-600">Days Since:</span>
                                <span id="days-since" class="text-gray-800 ml-2"></span>
                            </div>
                            <div>
                                <span class="font-medium text-gray-600">Max Results per Profile:</span>
                                <span id="max-results" class="text-gray-800 ml-2"></span>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <p class="text-gray-500">No configuration data available.</p>
            {% endif %}
        </div>

        <!-- Extraction Configuration -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Extraction Configuration</h2>
            {% if run.input %}
                <div class="space-y-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Extraction Prompt</h3>
                        <div class="space-y-3">
                            <textarea id="extraction-prompt-textarea" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 text-sm" placeholder="Enter extraction prompt...">{{ run.input.extraction_prompt|default:"Extract location information, business mentions, and contact details from social media posts." }}</textarea>
                            <div class="flex items-center space-x-3">
                                <button id="rerun-button" class="hidden inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg transition-colors duration-200" onclick="rerunWithModifiedPrompt()">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                    </svg>
                                    Rerun with Modified Prompt
                                </button>
                                <span id="prompt-changed-indicator" class="hidden text-sm text-orange-600">Prompt has been modified</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Raw Configuration</h3>
                        <div class="bg-gray-50 rounded-lg p-4 max-h-32 overflow-y-auto">
                            <pre class="text-xs text-gray-800 whitespace-pre-wrap">{{ run.input }}</pre>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Execution Details -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Execution Details</h2>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700">Execution ID</span>
                    <span class="text-sm text-gray-900">
                        {% if run.n8n_execution_id %}
                            {{ run.n8n_execution_id }}
                        {% else %}
                            <span class="text-gray-500">Not started</span>
                        {% endif %}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700">Status</span>
                    <span class="text-sm text-gray-900" id="status-display">
                        {% if execution_status == 'success' %}
                            Completed
                        {% elif execution_status == 'running' %}
                            Running
                        {% elif execution_status == 'waiting' %}
                            Waiting
                        {% elif execution_status == 'failed' or execution_status == 'error' %}
                            Failed
                        {% else %}
                            {{ execution_status|title }}
                        {% endif %}
                    </span>
                </div>
                {% if execution_data %}
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700">Duration</span>
                    <span class="text-sm text-gray-900" id="duration-display">Calculating...</span>
                </div>
                {% endif %}
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-700">Created</span>
                    <span class="text-sm text-gray-900">{{ run.created_at|date:"M j, Y g:i A" }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Debug Info (remove after troubleshooting) -->
    <div class="mt-8 bg-gray-100 rounded-lg p-4 text-xs">
        <h3 class="font-medium mb-2">Debug Info:</h3>
        <p><strong>run.input:</strong> <code>{{ run.input|truncatechars:200 }}</code></p>
        <p><strong>run.output:</strong> <code>{{ run.output|truncatechars:100 }}</code></p>
        <p><strong>run.extracted:</strong> <code>{{ run.extracted|truncatechars:100 }}</code></p>
        <p><strong>run.scraped:</strong> <code>{{ run.scraped|truncatechars:100 }}</code></p>
        <div id="js-debug" class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
            <strong>JS Debug:</strong> <span id="js-debug-content">Loading...</span>
        </div>
    </div>

    <!-- Output Data -->
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">Extracted Data</h2>
        <div class="space-y-4">
            {% if run.extracted %}
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-green-800">Extracted Data Available</h3>
                     <div class="mt-2 flex items-center space-x-4">
                             <button class="text-sm text-green-700 hover:text-green-900 underline" onclick="toggleExtractedData()">
                                 Show Processed Entities
                             </button>
                             <div class="flex space-x-2">
                                 <a href="{% url 'export_run_csv' run.pk %}"
                                    class="inline-flex items-center px-3 py-1 text-xs font-medium text-green-700 bg-green-100 hover:bg-green-200 rounded-md transition-colors">
                                     <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                     </svg>
                                     Export CSV
                                 </a>
                                 <a href="{% url 'export_run_json' run.pk %}"
                                    class="inline-flex items-center px-3 py-1 text-xs font-medium text-green-700 bg-green-100 hover:bg-green-200 rounded-md transition-colors">
                                     <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                     </svg>
                                     Export JSON
                                 </a>
                             </div>
                         </div>
                    </div>
                </div>
                 <div id="extracted-data" class="hidden mt-4 bg-gray-50 rounded-lg p-4">
                     <h3 class="text-sm font-medium text-gray-900 mb-3">Processed Entities</h3>
                     <div id="extracted-table-container" class="overflow-x-auto max-h-96">
                         <table id="extracted-table" class="min-w-full divide-y divide-gray-200">
                             <thead class="bg-gray-100 sticky top-0">
                                 <tr id="table-headers"></tr>
                             </thead>
                             <tbody id="table-body" class="bg-white divide-y divide-gray-200"></tbody>
                         </table>
                         <div id="no-data-message" class="text-center py-8 text-gray-500 hidden">
                             No entities to display
                         </div>
                     </div>
                 </div>
            </div>
            {% elif run.output %}
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Legacy Data Available</h3>
                        <div class="mt-2">
                            <button class="text-sm text-blue-700 hover:text-blue-900 underline" onclick="toggleLegacyData()">
                                Show Legacy Extracted Data
                            </button>
                        </div>
                    </div>
                </div>
                <div id="legacy-data" class="hidden mt-4 bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">Legacy Extracted Data</h3>
                    <pre id="output-json" class="text-sm text-gray-800 whitespace-pre-wrap"></pre>
                </div>
            </div>
            {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">No Data Available Yet</h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p>Data will appear here once the n8n workflow completes processing. The workflow needs to be updated to populate the new <code>scraped</code> and <code>extracted</code> fields.</p>
                        </div>
                    </div>
                </div>
            {% endif %}

            {% if run.scraped %}
            <div class="border-t pt-4">
                <button id="scraped-toggle" class="text-sm text-blue-600 hover:text-blue-800 underline" onclick="toggleScrapedData()">
                    Show Raw Scraped Data
                </button>
                <div id="scraped-data" class="hidden mt-2 bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                    <h3 class="text-sm font-medium text-gray-900 mb-2">Raw Scraped Posts</h3>
                    <pre id="scraped-json" class="text-sm text-gray-800 whitespace-pre-wrap"></pre>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% load static %}

<script>
let pollingInterval;

function formatDuration(ms) {
    if (ms < 1000) return 'Less than 1s';
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) return `${days}d ${hours % 24}h ${minutes % 60}m ${seconds % 60}s`;
    if (hours > 0) return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
    if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
    return `${seconds}s`;
}

function initializePromptEditing(originalPrompt) {
    const textarea = document.getElementById('extraction-prompt-textarea');
    const rerunButton = document.getElementById('rerun-button');
    const changedIndicator = document.getElementById('prompt-changed-indicator');

    textarea.value = originalPrompt;

    textarea.addEventListener('input', function() {
        const hasChanged = textarea.value.trim() !== originalPrompt.trim();
        if (hasChanged) {
            rerunButton.classList.remove('hidden');
            changedIndicator.classList.remove('hidden');
        } else {
            rerunButton.classList.add('hidden');
            changedIndicator.classList.add('hidden');
        }
    });
}

function rerunWithModifiedPrompt() {
    const textarea = document.getElementById('extraction-prompt-textarea');
    const newPrompt = textarea.value.trim();

    if (!newPrompt) {
        alert('Please enter an extraction prompt.');
        return;
    }

    // For now, just show an alert. In the future, this would trigger a rerun
    alert(`Rerun functionality coming soon!\n\nNew prompt: ${newPrompt}`);

    // TODO: Implement actual rerun API call
    // fetch(`/runs/{{ run.pk }}/rerun/`, {
    //     method: 'POST',
    //     headers: {
    //         'Content-Type': 'application/json',
    //         'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    //     },
    //     body: JSON.stringify({ extraction_prompt: newPrompt })
    // })
}

function renderExtractedTable(extractedData) {
    console.log('Extracted data:', extractedData);

    let entities = [];

    // Handle different data structures
    if (extractedData.result && Array.isArray(extractedData.result)) {
        entities = extractedData.result;
    } else if (extractedData.results && Array.isArray(extractedData.results)) {
        entities = extractedData.results;
    } else if (Array.isArray(extractedData)) {
        entities = extractedData;
    } else if (extractedData.output && extractedData.output.results && Array.isArray(extractedData.output.results)) {
        entities = extractedData.output.results;
    } else if (extractedData.output && extractedData.output.result && Array.isArray(extractedData.output.result)) {
        entities = extractedData.output.result;
    } else {
        console.warn('Unknown extracted data structure:', extractedData);
    }

    console.log('Found entities:', entities);

    const tableHeaders = document.getElementById('table-headers');
    const tableBody = document.getElementById('table-body');
    const noDataMessage = document.getElementById('no-data-message');

    if (!entities || entities.length === 0) {
        tableHeaders.innerHTML = '';
        tableBody.innerHTML = '';
        noDataMessage.classList.remove('hidden');
        return;
    }

    noDataMessage.classList.add('hidden');

    // Get column headers from first entity
    const columns = Object.keys(entities[0]);

    // Generate table headers
    tableHeaders.innerHTML = columns.map(col => `
        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            ${col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
        </th>
    `).join('');

    // Generate table rows
    tableBody.innerHTML = entities.map(entity => `
        <tr class="hover:bg-gray-50">
            ${columns.map(col => {
                const value = entity[col];
                let displayValue = '';
                let cellClass = 'px-4 py-3 text-sm text-gray-900';

                if (Array.isArray(value)) {
                    displayValue = value.join(', ');
                    cellClass += ' array-cell';
                } else if (typeof value === 'object' && value !== null) {
                    displayValue = JSON.stringify(value, null, 2);
                    cellClass += ' object-cell font-mono text-xs bg-gray-50';
                } else if (typeof value === 'number') {
                    displayValue = value.toString();
                    cellClass += ' text-right';
                } else {
                    displayValue = value || '';
                }

                return `<td class="${cellClass}" title="${typeof value === 'string' ? value : JSON.stringify(value)}">${displayValue}</td>`;
            }).join('')}
        </tr>
    `).join('');
}

function updateStatusAndDuration(data) {
    if (!data) return;

    // Update status
    const statusElement = document.getElementById('status-display');
    let statusText = data.status || 'unknown';
    if (statusText === 'success' || statusText === 'completed' || statusText === 'finished') statusText = 'Completed';
    else if (statusText === 'running') statusText = 'Running';
    else if (statusText === 'waiting') statusText = 'Waiting';
    else if (statusText === 'failed' || statusText === 'error' || statusText === 'cancelled') statusText = 'Failed';
    else statusText = statusText.charAt(0).toUpperCase() + statusText.slice(1);
    statusElement.textContent = statusText;

    // Update duration
    const durationElement = document.getElementById('duration-display');
    if (data.startedAt) {
        const startTime = new Date(data.startedAt);
        const endTime = data.stoppedAt ? new Date(data.stoppedAt) : new Date();
        const durationMs = endTime - startTime;

        // Show "In Progress" for running tasks without stoppedAt
        if (!data.stoppedAt && (data.status === 'running' || data.status === 'waiting')) {
            durationElement.textContent = 'In Progress';
        } else {
            durationElement.textContent = formatDuration(durationMs);
        }
    } else {
        durationElement.textContent = 'Not started';
    }
}

function pollStatus() {
    fetch(`/runs/{{ run.pk }}/status/`)
        .then(response => response.json())
        .then(data => {
            updateStatusAndDuration(data.data);
            // Stop polling if completed, failed, or cancelled
            if (['success', 'completed', 'finished', 'failed', 'error', 'cancelled'].includes(data.status)) {
                clearInterval(pollingInterval);
            }
        })
        .catch(error => console.error('Polling error:', error));
}

// Initial update
const initialData = {{ execution_data_json|safe }};
updateStatusAndDuration(initialData);

// Populate configuration data
{% if run.input %}
const rawInput = document.getElementById('input-data').textContent;
const debugElement = document.getElementById('js-debug-content');

debugElement.textContent = `Raw length: ${rawInput.length}, starts with: "${rawInput.substring(0, 50)}..."`;

try {
    const inputData = JSON.parse(rawInput);
    debugElement.textContent += ' | Successfully parsed JSON';

    document.getElementById('days-since').textContent = inputData.days_since || 'N/A';
    document.getElementById('max-results').textContent = inputData.max_results || 'N/A';

    const profilesList = document.getElementById('profiles-list');
    if (inputData.profiles && Array.isArray(inputData.profiles)) {
        inputData.profiles.forEach(profile => {
            const li = document.createElement('li');
            li.textContent = `â€¢ ${profile}`;
            profilesList.appendChild(li);
        });
    } else {
        const li = document.createElement('li');
        li.textContent = 'No profiles configured';
        profilesList.appendChild(li);
    }

    // Initialize extraction prompt editing
    initializePromptEditing(inputData.extraction_prompt || 'Extract location information, business mentions, and contact details from social media posts.');

} catch (e) {
    debugElement.textContent += ` | Parse error: ${e.message}`;

    // Fallback: try to display raw data
    document.getElementById('days-since').textContent = 'Parse error - check debug below';
    document.getElementById('max-results').textContent = 'Parse error - check debug below';

    const profilesList = document.getElementById('profiles-list');
    const li = document.createElement('li');
    li.textContent = 'Parse error - check debug section';
    profilesList.appendChild(li);
}
{% endif %}

// Format table output
{% if run.extracted %}
try {
    const extractedData = {{ run.extracted|safe }};
    renderExtractedTable(extractedData);
} catch (e) {
    console.error('Failed to format extracted data:', e);
    document.getElementById('extracted-table-container').innerHTML = '<p class="text-red-600">Error loading data</p>';
}
{% endif %}

{% if run.scraped %}
try {
    const scrapedData = {{ run.scraped|safe }};
    // Assume scraped data has a 'result' key with array of JSON objects
    const scrapedEntities = scrapedData.result || scrapedData.results || scrapedData;
    if (Array.isArray(scrapedEntities)) {
        document.getElementById('scraped-json').textContent = JSON.stringify(scrapedEntities, null, 2);
    } else {
        document.getElementById('scraped-json').textContent = JSON.stringify(scrapedData, null, 2);
    }
} catch (e) {
    console.error('Failed to format scraped data:', e);
    document.getElementById('scraped-json').textContent = 'Error formatting data';
}
{% endif %}

function toggleExtractedData() {
    const extractedDiv = document.getElementById('extracted-data');
    const toggleButton = extractedDiv.previousElementSibling.querySelector('button');

    if (extractedDiv.classList.contains('hidden')) {
        extractedDiv.classList.remove('hidden');
        toggleButton.textContent = 'Hide Processed Entities';
    } else {
        extractedDiv.classList.add('hidden');
        toggleButton.textContent = 'Show Processed Entities';
    }
}

function toggleLegacyData() {
    const legacyDiv = document.getElementById('legacy-data');
    const toggleButton = legacyDiv.previousElementSibling.querySelector('button');

    if (legacyDiv.classList.contains('hidden')) {
        legacyDiv.classList.remove('hidden');
        toggleButton.textContent = 'Hide Legacy Extracted Data';
    } else {
        legacyDiv.classList.add('hidden');
        toggleButton.textContent = 'Show Legacy Extracted Data';
    }
}

function toggleScrapedData() {
    const scrapedDiv = document.getElementById('scraped-data');
    const toggleButton = document.getElementById('scraped-toggle');

    if (scrapedDiv.classList.contains('hidden')) {
        scrapedDiv.classList.remove('hidden');
        toggleButton.textContent = 'Hide Raw Scraped Data';
    } else {
        scrapedDiv.classList.add('hidden');
        toggleButton.textContent = 'Show Raw Scraped Data';
    }
}

// Start polling if execution is running
{% if run.n8n_execution_id and execution_status != 'success' and execution_status != 'failed' and execution_status != 'error' and execution_status != 'completed' and execution_status != 'finished' %}
pollingInterval = setInterval(pollStatus, 10000); // Poll every 10 seconds
{% endif %}
</script>
{% endblock %}
{% extends "base.html" %}
{% load static %}

{% block title %}Create New Run - Vibe Scraper SaaS{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Create New Scraping Run</h1>
    
    <form method="post" id="run-form">
        {% csrf_token %}
        
        <!-- Hidden required fields -->
        <input type="hidden" name="days_since" value="14">
        <input type="hidden" name="auto_infer_columns" value="true">
        <input type="hidden" name="custom_columns" value="[]">
        <input type="hidden" name="max_results" value="50">
        
        
        
        <!-- Sources Configuration -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Sources Configuration</h2>
            
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <p class="text-sm text-blue-800">
                    <strong>ðŸ”„ Multi-Source Support:</strong> Add multiple sources from different platforms (YouTube, Instagram, TikTok) in a single run. 
                    Each source can have different configuration options based on the platform and source type.
                </p>
            </div>
            
            <div id="sources-container">
                {% for form in source_formset %}
                    {% include "core/run_create/partials/source_card.html" %}
                {% endfor %}
            </div>
            
            <button type="button" id="add-source-btn" class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg mt-4">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add Source
            </button>
            
            {{ source_formset.management_form }}
        </div>
        
        <!-- Extraction Configuration -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Extraction Configuration</h2>
            
            <div class="space-y-6">
                <!-- Enable Extraction -->
                <div>
                    <label class="flex items-center">
                        {{ form.enable_extraction }}
                        <span class="ml-2 text-sm font-medium text-gray-700">{{ form.enable_extraction.label }}</span>
                    </label>
                    {% if form.enable_extraction.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.enable_extraction.help_text }}</p>
                    {% endif %}
                    {% if form.enable_extraction.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.enable_extraction.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <!-- Extraction Prompt -->
                <div>
                    <label for="{{ form.extraction_prompt.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        {{ form.extraction_prompt.label }}
                    </label>
                    {{ form.extraction_prompt }}
                    {% if form.extraction_prompt.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.extraction_prompt.help_text }}</p>
                    {% endif %}
                    {% if form.extraction_prompt.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.extraction_prompt.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <button type="submit" class="inline-flex items-center px-6 py-3 bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-lg transition-colors duration-200 shadow-md hover:shadow-lg">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Start Scraping Run
            </button>
            <a href="{% url 'run_list' %}" class="ml-4 inline-flex items-center px-4 py-2 text-gray-700 hover:text-gray-900 font-medium">
                Cancel
            </a>
        </div>
        
        </form>
</div>

<!-- Multi-Source Form JavaScript -->
<script>
// Make updatePlatformConfig globally accessible
function updatePlatformConfig(sourceTypeSelect) {
    const sourceCard = sourceTypeSelect.closest('.source-card');
    if (!sourceCard) return;
    
    const container = sourceCard.querySelector('.platform-config-container');
    if (!container) return;
    
    const selectedType = sourceTypeSelect.value;
    
    // Hide all platform configs and disable their form fields
    const allConfigs = container.querySelectorAll('.platform-config');
    allConfigs.forEach(config => {
        config.style.display = 'none';
        // Disable all form fields in hidden configs
        const fields = config.querySelectorAll('input, select, textarea');
        fields.forEach(field => {
            field.disabled = true;
        });
    });
    
    // Show selected platform config and enable its form fields
    if (selectedType) {
        const configClassName = selectedType + '-config';
        const targetConfig = container.querySelector('.' + configClassName);
        if (targetConfig) {
            targetConfig.style.display = 'block';
            // Enable all form fields in visible config
            const fields = targetConfig.querySelectorAll('input, select, textarea');
            fields.forEach(field => {
                field.disabled = false;
            });
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const addSourceBtn = document.getElementById('add-source-btn');
    const sourcesContainer = document.getElementById('sources-container');
    
    // Add source functionality
    if (addSourceBtn) {
        addSourceBtn.addEventListener('click', function() {
            const formCount = document.querySelectorAll('.source-card').length;
            const totalFormsInput = document.querySelector('#id_form-TOTAL_FORMS');
            
            // Clone the first form as a template
            const firstForm = document.querySelector('.source-card');
            if (!firstForm) return;
            
            const newForm = firstForm.cloneNode(true);
            
            // Update form indices
            const newFormHtml = newForm.innerHTML.replace(/form-\d+/g, `form-${formCount}`);
            newForm.innerHTML = newFormHtml;
            
            // Clear values in the new form
            const inputs = newForm.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = false;
                } else if (input.type !== 'hidden') {
                    input.value = '';
                }
            });
            
            // Hide all platform configs in the new form
            const platformConfigs = newForm.querySelectorAll('.platform-config');
            platformConfigs.forEach(config => {
                config.style.display = 'none';
            });
            
            // Update source number
            const title = newForm.querySelector('h3');
            if (title) {
                title.textContent = `Source ${formCount + 1}`;
            }
            
            sourcesContainer.appendChild(newForm);
            
            // Update formset management form
            if (totalFormsInput) {
                totalFormsInput.value = formCount + 1;
            }
        });
    }
    
    // Handle source type changes for all forms
    document.addEventListener('change', function(e) {
        if (e.target.matches('.source-type-select')) {
            updatePlatformConfig(e.target);
        }
    });
    
    // Handle remove source buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.remove-source')) {
            e.preventDefault();
            const sourceCard = e.target.closest('.source-card');
            if (!sourceCard) return;
            
            // Find DELETE checkbox and check it
            const deleteCheckbox = sourceCard.querySelector('[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                sourceCard.style.display = 'none';
            } else {
                // If no DELETE checkbox, just remove it
                sourceCard.remove();
            }
            
            // Update form count and management form
            const totalFormsInput = document.querySelector('#id_form-TOTAL_FORMS');
            const visibleCards = document.querySelectorAll('.source-card:not([style*="display: none"])');
            
            if (totalFormsInput) {
                totalFormsInput.value = visibleCards.length;
            }
            
            // Renumber visible sources
            visibleCards.forEach((card, index) => {
                const title = card.querySelector('h3');
                if (title) {
                    title.textContent = `Source ${index + 1}`;
                }
            });
        }
    });
    
    // Initialize existing forms
    document.querySelectorAll('.source-type-select').forEach(select => {
        updatePlatformConfig(select);
    });
});
</script>
{% endblock %}
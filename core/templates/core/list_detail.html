{% extends "base.html" %}

{% block title %}{{ list.name }} - Vibe Scraper SaaS{% endblock %}

{% block content %}
<!-- CSRF protection enabled -->

<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="mb-8">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ list.name }}</h1>
                {% if list.description %}
                <p class="text-gray-600">{{ list.description }}</p>
                {% endif %}
                <p class="text-sm text-gray-500 mt-2">{{ rows|length }} items</p>
            </div>
            <div class="flex space-x-4">
                <a href="{% url 'list_list' %}"
                   class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg transition-colors duration-200">
                    ‚Üê Back to Lists
                </a>
                {% if rows %}
                <a href="{% url 'export_list_csv' list.pk %}"
                   class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-colors duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Export CSV
                </a>
                {% endif %}
                <button onclick="showDeleteListModal()"
                        class="inline-flex items-center px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete List
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table id="notion-table" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        {% for column in columns %}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200 relative group column-header" data-column-id="{{ column.pk }}">
                            <div class="flex items-center justify-between">
                                <span class="cursor-pointer hover:text-gray-700 column-name" onclick="toggleColumnDropdown({{ column.pk }})">
                                    {{ column.name }}
                                    {% if column.required %}<span class="text-red-500 ml-1">*</span>{% endif %}
                                </span>
                                <span class="text-xs text-gray-400 ml-2">({{ column.get_column_type_display }})</span>
                                <button onclick="toggleColumnDropdown({{ column.pk }})" class="ml-2 opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-gray-200 transition-opacity">
                                    <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- Column Dropdown -->
                            <div id="column-dropdown-{{ column.pk }}" class="absolute bottom-full left-0 mb-1 w-64 bg-white border border-gray-200 rounded-md shadow-lg z-20 hidden column-dropdown">
                                <div class="py-2">
                                    <!-- Edit Name -->
                                    <div class="px-4 py-2 border-b border-gray-100">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-600">‚úèÔ∏è</span>
                                            <input type="text" id="column-name-input-{{ column.pk }}"
                                                   class="flex-1 text-sm border border-gray-300 rounded px-2 py-1 focus:outline-none focus:border-blue-500"
                                                   value="{{ column.name }}"
                                                   onblur="updateColumnName({{ column.pk }})"
                                                   onkeypress="handleNameKeypress(event, {{ column.pk }})">
                                        </div>
                                    </div>

                                    <!-- Change Type -->
                                    <div class="px-4 py-2 border-b border-gray-100">
                                        <div class="relative">
                                            <button onclick="toggleTypeDropdown({{ column.pk }})" class="flex items-center justify-between w-full text-sm text-gray-700 hover:bg-gray-50 px-2 py-1 rounded">
                                                <div class="flex items-center space-x-2">
                                                    <span>üîÑ</span>
                                                    <span>Change Type</span>
                                                </div>
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                                </svg>
                                            </button>
                                            <!-- Type Dropdown -->
                                            <div id="type-dropdown-{{ column.pk }}" class="absolute left-full top-0 ml-1 w-40 bg-white border border-gray-200 rounded-md shadow-lg hidden">
                                                <div class="py-1">
                                                    <button onclick="changeColumnType({{ column.pk }}, 'text')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Text</button>
                                                    <button onclick="changeColumnType({{ column.pk }}, 'number')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Number</button>
                                                    <button onclick="changeColumnType({{ column.pk }}, 'date')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Date</button>
                                                    <button onclick="changeColumnType({{ column.pk }}, 'boolean')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Checkbox</button>
                                                    <button onclick="changeColumnType({{ column.pk }}, 'select')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Select</button>
                                                    <button onclick="changeColumnType({{ column.pk }}, 'multi_select')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Multi Select</button>
                                                    <button onclick="changeColumnType({{ column.pk }}, 'url')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">URL</button>
        </div>

        {% if not columns %}
        <div class="text-center py-8 border-t border-gray-200 bg-gray-50">
            <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No columns defined yet</h3>
            <p class="mt-1 text-sm text-gray-500">Click the + button above to add your first column and start organizing your data.</p>
        </div>
        {% endif %}
    </div>
</div>
                                    </div>

                                    <!-- Description -->
                                    <div class="px-4 py-2 border-b border-gray-100">
                                        <div class="flex items-center space-x-2 mb-1">
                                            <span class="text-sm text-gray-600">üìù</span>
                                            <span class="text-sm text-gray-700">Description</span>
                                        </div>
                                        <textarea id="column-description-{{ column.pk }}"
                                                  class="w-full text-sm border border-gray-300 rounded px-2 py-1 focus:outline-none focus:border-blue-500 resize-none"
                                                  rows="2"
                                                  placeholder="Optional description"
                                                  onblur="updateColumnDescription({{ column.pk }})">{{ column.description|default:"" }}</textarea>
                                    </div>

                                    <!-- Required -->
                                    <div class="px-4 py-2 border-b border-gray-100">
                                        <label class="flex items-center space-x-2 cursor-pointer">
                                            <input type="checkbox" id="column-required-{{ column.pk }}"
                                                   {% if column.required %}checked{% endif %}
                                                   onchange="updateColumnRequired({{ column.pk }})"
                                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                            <span class="text-sm text-gray-700">Required field</span>
                                        </label>
                                    </div>

                                    <!-- Delete Column -->
                                    <div class="px-4 py-2">
                                        <button onclick="deleteColumn({{ column.pk }}, '{{ column.name }}')"
                                                class="flex items-center space-x-2 text-red-600 hover:text-red-800 text-sm w-full text-left">
                                            <span>üóëÔ∏è</span>
                                            <span>Delete Column</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </th>
                        {% endfor %}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-16">
                            <div class="relative">
                                <button id="add-column-btn" class="p-1 rounded hover:bg-gray-200 transition-colors text-gray-500 text-lg font-bold">
                                    +
                                </button>
                                <!-- Column Type Dropdown -->
                                <div id="column-type-dropdown" class="absolute right-0 top-full mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-10 hidden">
                                    <div class="py-1">
                                        <button onclick="addColumn('text')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Text</button>
                                        <button onclick="addColumn('number')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Number</button>
                                        <button onclick="addColumn('date')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Date</button>
                                        <button onclick="addColumn('boolean')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Checkbox</button>
                                        <button onclick="addColumn('select')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Select</button>
                                        <button onclick="addColumn('multi_select')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Multi Select</button>
                                        <button onclick="addColumn('url')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">URL</button>
                                    </div>
                                </div>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for row in rows %}
                    <tr class="hover:bg-gray-50 group" data-row-id="{{ row.pk }}">
                        {% for column in columns %}
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900 border-r border-gray-100 cursor-pointer hover:bg-blue-50 transition-colors"
                            onclick="editCell({{ row.pk }}, '{{ column.name }}', '{{ column.column_type }}', this)"
                            data-column="{{ column.name }}"
                            data-type="{{ column.column_type }}">
                            {% load custom_filters %}
                            {% get_dict_value row.data column.name as value %}
                            {% if value %}
                                {% if column.column_type == 'boolean' %}
                                    <div class="flex items-center">
                                        <input type="checkbox" {% if value %}checked{% endif %} disabled class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                    </div>
                                {% elif column.column_type == 'select' %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">{{ value }}</span>
                                {% elif column.column_type == 'multi_select' %}
                                    <div class="flex flex-wrap gap-1">
                                        {% for tag in value %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">{{ tag }}</span>
                                        {% endfor %}
                                    </div>
                                {% elif column.column_type == 'url' %}
                                    <a href="{{ value }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline">{{ value|truncatechars:30 }}</a>
                                {% elif column.column_type == 'date' %}
                                    {{ value|date:"M j, Y" }}
                                {% else %}
                                    {{ value|truncatechars:50 }}
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400 italic">Empty</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500 w-16">
                            <button onclick="deleteRow({{ row.pk }})" class="opacity-0 group-hover:opacity-100 p-1 rounded hover:bg-red-100 transition-all">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    <!-- Add new row -->
                    <tr id="new-row-template" class="hover:bg-gray-50 border-t-2 border-dashed border-gray-300">
                        {% for column in columns %}
                        <td class="px-6 py-3 whitespace-nowrap text-sm border-r border-gray-100">
                            <span class="text-gray-400 italic">Click to add</span>
                        </td>
                        {% endfor %}
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-500 w-16">
                            <button onclick="addNewRow()" class="p-1 rounded hover:bg-green-100 transition-colors">
                                <svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Inline Edit Modal -->
<div id="edit-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4" id="edit-modal-title">Edit Cell</h3>
            <div id="edit-modal-content">
                <!-- Dynamic content will be inserted here -->
            </div>
            <div class="flex justify-end space-x-3 mt-4">
                <button onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                <button onclick="saveCellEdit()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete List Modal -->
<div id="delete-list-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-red-600 mb-4">Delete List</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">This action cannot be undone. All data in this list will be permanently deleted.</p>
                <p class="text-sm text-gray-600 mb-4">Type <strong>"{{ list.name }}"</strong> to confirm:</p>
                <input type="text" id="delete-confirmation-input"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500"
                       placeholder="Type the list name here">
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="hideDeleteListModal()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Cancel</button>
                <button onclick="confirmDeleteList()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete List</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// CSRF token setup for AJAX requests
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Global variables
let currentEditCell = null;
let currentEditRowId = null;
let currentEditColumn = null;
let currentEditType = null;

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    setupColumnDropdown();
});

// Setup column dropdown toggle
function setupColumnDropdown() {
    const btn = document.getElementById('add-column-btn');
    const dropdown = document.getElementById('column-type-dropdown');

    btn.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!btn.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });
}

// Add new column
function addColumn(type) {
    const listId = {{ list.pk }};
    const columnName = prompt(`Enter ${type} column name:`);
    if (!columnName) return;

    fetch(`/lists/${listId}/columns/create/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `name=${encodeURIComponent(columnName)}&column_type=${type}&required=false`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error adding column');
        }
    });
}

// Edit cell inline
function editCell(rowId, columnName, columnType, cellElement) {
    currentEditCell = cellElement;
    currentEditRowId = rowId;
    currentEditColumn = columnName;
    currentEditType = columnType;

    const currentValue = cellElement.textContent.trim();
    const modal = document.getElementById('edit-modal');
    const content = document.getElementById('edit-modal-content');

    let inputHtml = '';

    switch(columnType) {
        case 'text':
            inputHtml = `<input type="text" id="edit-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${currentValue === 'Empty' ? '' : currentValue}">`;
            break;
        case 'number':
            inputHtml = `<input type="number" id="edit-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${currentValue === 'Empty' ? '' : currentValue}">`;
            break;
        case 'date':
            inputHtml = `<input type="date" id="edit-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${currentValue === 'Empty' ? '' : currentValue}">`;
            break;
        case 'boolean':
            const isChecked = cellElement.querySelector('input')?.checked || false;
            inputHtml = `<input type="checkbox" id="edit-input" ${isChecked ? 'checked' : ''} class="rounded border-gray-300 text-blue-600">`;
            break;
        case 'url':
            inputHtml = `<input type="url" id="edit-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${currentValue === 'Empty' ? '' : currentValue}">`;
            break;
        case 'select':
            inputHtml = `<select id="edit-input" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="">Select...</option>
                <option value="Active" ${currentValue === 'Active' ? 'selected' : ''}>Active</option>
                <option value="Pending" ${currentValue === 'Pending' ? 'selected' : ''}>Pending</option>
                <option value="Completed" ${currentValue === 'Completed' ? 'selected' : ''}>Completed</option>
                <option value="Archived" ${currentValue === 'Archived' ? 'selected' : ''}>Archived</option>
            </select>`;
            break;
        default:
            inputHtml = `<input type="text" id="edit-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="${currentValue === 'Empty' ? '' : currentValue}">`;
    }

    content.innerHTML = inputHtml;
    modal.classList.remove('hidden');

    // Focus the input
    setTimeout(() => {
        const input = document.getElementById('edit-input');
        if (input) input.focus();
    }, 100);
}

// Save cell edit
function saveCellEdit() {
    const input = document.getElementById('edit-input');
    if (!input) return;

    let value;
    if (currentEditType === 'boolean') {
        value = input.checked;
    } else {
        value = input.value;
    }

    // Send AJAX request to update the cell
    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/rows/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `row_id=${currentEditRowId}&column=${encodeURIComponent(currentEditColumn)}&value=${encodeURIComponent(value)}&type=${currentEditType}`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error updating cell');
        }
    });

    closeEditModal();
}

// Close edit modal
function closeEditModal() {
    document.getElementById('edit-modal').classList.add('hidden');
    currentEditCell = null;
    currentEditRowId = null;
    currentEditColumn = null;
    currentEditType = null;
}

// Add new row
function addNewRow() {
    const listId = {{ list.pk }};
    // Redirect to the row creation page
    window.location.href = `/lists/${listId}/rows/create/`;
}

// Delete row
function deleteRow(rowId) {
    if (!confirm('Are you sure you want to delete this row?')) return;

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/rows/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `row_id=${rowId}`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error deleting row');
        }
    });
}

// CSRF protection enabled

// Column dropdown management
let activeColumnDropdown = null;
let activeTypeDropdown = null;

function toggleColumnDropdown(columnId) {
    const dropdown = document.getElementById(`column-dropdown-${columnId}`);

    // Close any other open dropdowns
    if (activeColumnDropdown && activeColumnDropdown !== dropdown) {
        activeColumnDropdown.classList.add('hidden');
    }

    // Close any open type dropdowns
    if (activeTypeDropdown) {
        activeTypeDropdown.classList.add('hidden');
        activeTypeDropdown = null;
    }

    // Toggle current dropdown
    dropdown.classList.toggle('hidden');

    if (!dropdown.classList.contains('hidden')) {
        activeColumnDropdown = dropdown;
        // Focus the name input
        const nameInput = document.getElementById(`column-name-input-${columnId}`);
        if (nameInput) {
            nameInput.focus();
            nameInput.select();
        }
    } else {
        activeColumnDropdown = null;
    }
}

function toggleTypeDropdown(columnId) {
    const dropdown = document.getElementById(`type-dropdown-${columnId}`);

    // Close any other type dropdowns
    if (activeTypeDropdown && activeTypeDropdown !== dropdown) {
        activeTypeDropdown.classList.add('hidden');
    }

    // Toggle current dropdown
    dropdown.classList.toggle('hidden');

    if (!dropdown.classList.contains('hidden')) {
        activeTypeDropdown = dropdown;
    } else {
        activeTypeDropdown = null;
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (activeColumnDropdown && !e.target.closest('.column-dropdown') && !e.target.closest('.column-header')) {
        activeColumnDropdown.classList.add('hidden');
        activeColumnDropdown = null;
    }
    if (activeTypeDropdown && !e.target.closest('#type-dropdown-')) {
        activeTypeDropdown.classList.add('hidden');
        activeTypeDropdown = null;
    }
});

// Column property updates
function handleNameKeypress(event, columnId) {
    if (event.key === 'Enter') {
        updateColumnName(columnId);
    } else if (event.key === 'Escape') {
        // Reset to original value
        const input = event.target;
        const originalName = input.defaultValue;
        input.value = originalName;
        toggleColumnDropdown(columnId);
    }
}

function updateColumnName(columnId) {
    const input = document.getElementById(`column-name-input-${columnId}`);
    const newName = input.value.trim();

    if (!newName) {
        alert('Column name cannot be empty');
        input.focus();
        return;
    }

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/columns/${columnId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `name=${encodeURIComponent(newName)}`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error updating column name');
        }
    });
}

function changeColumnType(columnId, newType) {
    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/columns/${columnId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `column_type=${encodeURIComponent(newType)}`
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error updating column type');
        }
    });
}

function updateColumnDescription(columnId) {
    const textarea = document.getElementById(`column-description-${columnId}`);
    const description = textarea.value.trim();

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/columns/${columnId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `description=${encodeURIComponent(description)}`
    })
    .then(response => {
        if (!response.ok) {
            alert('Error updating column description');
        }
    });
}

function updateColumnRequired(columnId) {
    const checkbox = document.getElementById(`column-required-${columnId}`);
    const required = checkbox.checked;

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/columns/${columnId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `required=${required}`
    })
    .then(response => {
        if (!response.ok) {
            alert('Error updating column required status');
        }
    });
}

function deleteColumn(columnId, columnName) {
    const confirmation = prompt(`Type "${columnName}" to confirm deletion:`);
    if (confirmation !== columnName) {
        alert('Column name does not match. Deletion cancelled.');
        return;
    }

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/columns/${columnId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: ''
    })
    .then(response => {
        if (response.ok) {
            location.reload();
        } else {
            alert('Error deleting column');
        }
    });
}

// Delete list modal functions
function showDeleteListModal() {
    document.getElementById('delete-list-modal').classList.remove('hidden');
    document.getElementById('delete-confirmation-input').focus();
}

function hideDeleteListModal() {
    document.getElementById('delete-list-modal').classList.add('hidden');
    document.getElementById('delete-confirmation-input').value = '';
}

function confirmDeleteList() {
    const input = document.getElementById('delete-confirmation-input');
    const confirmation = input.value.trim();
    const listName = '{{ list.name }}';

    if (confirmation !== listName) {
        alert('Please type the exact list name to confirm deletion.');
        input.focus();
        return;
    }

    const listId = {{ list.pk }};
    fetch(`/lists/${listId}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken,
        },
        body: `confirmation=${encodeURIComponent(confirmation)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{% url "list_list" %}';
        } else {
            alert(data.error || 'Error deleting list');
        }
    })
    .catch(error => {
        alert('Error deleting list');
    });
}
</script>
{% endblock %}